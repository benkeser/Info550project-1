---
title: "Homework 3"
author: "Catie Lott"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document: default
---

```{r, add-packages, include=FALSE}
if(!require("dplyr"))(install.packages("dplyr"))
library("dplyr")
if(!require("ggplot2"))(install.packages("ggplot2"))
library("ggplot2")
if(!require("readxl"))(install.packages("readxl"))
library("readxl")
if(!require("lubridate"))(install.packages("lubridate"))
library("lubridate")
```

```{r, data-import, include=FALSE, warning=FALSE}
#packages used: readxl
covid_cases <- read.csv("Data/VDH-COVID-19-PublicUseDataset-Cases.csv")
head(covid_cases)
income <- read_excel("Data/county5.xls", range="MG2000!B2824:K2959", col_names=c("County", "FIPS", "GINI", "Mean_Income"), col_types=c("text", "numeric", "skip", "numeric", "skip", "skip", "skip", "skip", "skip", "numeric"))
head(covid_cases)
```

```{r, clean-and-merge-tables, include=FALSE}
#packages used: dplyr, lubridate (requires tidyverse), 
VA_covid_messy <- covid_cases %>% 
  full_join(income, by="FIPS", na.rm=T) %>% 
  select(Report.Date, FIPS, Locality, VDH.Health.District, GINI, 
         Mean_Income, Total.Cases, Hospitalizations, Deaths)
VA_covid_messy[!complete.cases(VA_covid_messy),]
VA_covid <- na.omit(VA_covid_messy)
VA_covid[!complete.cases(VA_covid),]
VA_covid$Report.Date <- sort(as.Date(VA_covid$Report.Date, format="%m/%d/%Y"))
Start.Week <- epiweek(VA_covid$Report.Date[1])
VA_covid <- VA_covid %>% mutate(Report.Week=case_when(
  year(Report.Date) == 2020 ~ epiweek(Report.Date)-Start.Week,
  year(Report.Date) == 2021 ~ epiweek(Report.Date)-Start.Week+52
))
quantile(VA_covid$GINI)
VA_covid <- VA_covid %>% 
  mutate(GINI.Quartile=ntile(GINI, 4))
head(VA_covid)
```


```{r, spaghetti-plot, echo=FALSE, warning=FALSE}
#packages used: ggplot2
p <- ggplot(VA_covid, aes(x=Report.Week, y=Deaths, group=FIPS, color=factor(FIPS)))
p + geom_line() + facet_grid(. ~ GINI.Quartile, labeller=labeller(GINI.Quartile=c("1"="GINI 1st Quartile", "2"="GINI 2nd Quartile", "3"="GINI 3rd Quartile", "4"="GINI 4th Quartile")))+ guides(colour="none") + scale_x_continuous(name="Weeks since 3/17/20") + scale_y_continuous(name="Deaths from COVID-19") + labs(title="COVID-19 deaths over time, stratified by inequality") + theme(plot.title=element_text(hjust = 0.5))
```

To analyze the COVID-19 outcomes and inequality in Virginia, I combined the COVID outcomes data from Virginia with income data for Virginia from the 2000 census. The income data and COVID-19 data were both separated geographically by county (indicated by FIPS code), and the income data included a calculated GINI coefficient for each county. I calculated the quantiles of the GINI coefficients from the Virginia counties and split the counties into quartiles based on where they fell in the distribution of inequality. I then graphed the COVID-19 deaths over time (by week) for each county and stratified the graphs by the predetermined inequality quartiles. Surprisingly, the counties with the highest COVID-19 deaths were also in the lowest inequality quartiles. The deaths are currently represented as raw numbers, not percent of the population, so this may be impacting the trends.

